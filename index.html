<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÅENAGRO Ä°ÅLETME TAKÄ°P</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* ... (Orijinal dosyadaki tÃ¼m CSS stilleri buraya kopyalandÄ±) ... */
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .content {
            padding: 30px;
            min-height: 600px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .card .value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card .label {
            font-size: 13px;
            opacity: 0.8;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            font-size: 13px;
        }

        .data-table tbody tr {
            border-bottom: 1px solid #dee2e6;
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .data-table tbody tr:last-child {
            border-bottom: none;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin-right: 5px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .report-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #dee2e6;
        }

        .report-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .kasa-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
        }

        .kasa-display h2 {
            font-size: 48px;
            margin: 10px 0;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .summary-item.gelir {
            border-left-color: #38ef7d;
        }

        .summary-item.gider {
            border-left-color: #f5576c;
        }

        .summary-item label {
            font-size: 13px;
            color: #6c757d;
            display: block;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .tabs {
                font-size: 12px;
            }
            
            .tab {
                padding: 12px 15px;
            }

            .content {
                padding: 15px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }

        .filter-section {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-section h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        /* YÃœKLENÄ°YOR SPINNER'I */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            z-index: 9998;
            display: none; /* BaÅŸlangÄ±Ã§ta gizli */
            justify-content: center;
            align-items: center;
        }
        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="spinner-overlay" id="spinnerOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸš› ÅENAGRO Ä°ÅLETME TAKÄ°P</h1>
            <p>Nakliye ve Ambar YÃ¶netim Sistemi</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">ğŸ“Š Dashboard</button>
            <button class="tab" onclick="showTab('tesis')">ğŸšª Tesis GiriÅŸ/Ã‡Ä±kÄ±ÅŸ</button>
            <button class="tab" onclick="showTab('arac')">â›½ AraÃ§ YakÄ±t Takibi</button>
            <button class="tab" onclick="showTab('personel')">ğŸ‘¥ Personel Takip</button>
            <button class="tab" onclick="showTab('giderler')">ğŸ’¸ Giderler</button>
            <button class="tab" onclick="showTab('gelirler')">ğŸ’° Gelirler</button>
            <button class="tab" onclick="showTab('kasa')">ğŸ¦ Kasa</button>
            <button class="tab" onclick="showTab('raporlar')">ğŸ“‹ Raporlar</button>
            <button class="tab" onclick="showTab('ayarlar')">âš™ï¸ Ayarlar</button>
        </div>

        <div class="content">
            <div id="dashboard" class="tab-content active">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Dashboard - Genel BakÄ±ÅŸ</h2>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <h3>BugÃ¼nkÃ¼ GiriÅŸ/Ã‡Ä±kÄ±ÅŸ</h3>
                        <div class="value" id="dashTesisCount">0</div>
                        <div class="label">AraÃ§ Hareketi</div>
                    </div>
                    <div class="card green">
                        <h3>GÃ¼ncel Kasa</h3>
                        <div class="value" id="dashKasa">0 â‚º</div>
                        <div class="label">Mevcut Bakiye</div>
                    </div>
                    <div class="card orange">
                        <h3>Toplam AraÃ§</h3>
                        <div class="value" id="dashAracCount">0</div>
                        <div class="label">KayÄ±tlÄ± AraÃ§</div>
                    </div>
                    <div class="card blue">
                        <h3>Toplam Personel</h3>
                        <div class="value" id="dashPersonelCount">0</div>
                        <div class="label">KayÄ±tlÄ± Personel</div>
                    </div>
                </div>

                <div class="summary-grid">
                    <div class="summary-item gelir">
                        <label>BugÃ¼nkÃ¼ Gelir</label>
                        <div class="value" id="dashBugunGelir">0 â‚º</div>
                    </div>
                    <div class="summary-item gider">
                        <label>BugÃ¼nkÃ¼ Gider</label>
                        <div class="value" id="dashBugunGider">0 â‚º</div>
                    </div>
                    <div class="summary-item">
                        <label>AylÄ±k Gelir</label>
                        <div class="value" id="dashAylikGelir">0 â‚º</div>
                    </div>
                    <div class="summary-item">
                        <label>AylÄ±k Gider</label>
                        <div class="value" id="dashAylikGider">0 â‚º</div>
                    </div>
                </div>
            </div>

            <div id="tesis" class="tab-content">
                <div class="form-section">
                    <h3>ğŸšª Tesis GiriÅŸ/Ã‡Ä±kÄ±ÅŸ KaydÄ±</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tarih/Saat *</label>
                            <input type="datetime-local" id="tesisTarih" required>
                        </div>
                        <div class="form-group">
                            <label>Ä°ÅŸlem TÃ¼rÃ¼ *</label>
                            <select id="tesisIslem" required>
                                <option value="">SeÃ§iniz</option>
                                <option value="GiriÅŸ">GiriÅŸ</option>
                                <option value="Ã‡Ä±kÄ±ÅŸ">Ã‡Ä±kÄ±ÅŸ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>AraÃ§ PlakasÄ± *</label>
                            <input type="text" id="tesisPlaka" placeholder="34 ABC 123" required>
                        </div>
                        <div class="form-group">
                            <label>ÅofÃ¶r *</label>
                            <input type="text" id="tesisSofor" placeholder="ÅofÃ¶r AdÄ±" required>
                        </div>
                        <div class="form-group">
                            <label>ÃœrÃ¼n *</label>
                            <input type="text" id="tesisUrun" placeholder="ÃœrÃ¼n AdÄ±" required>
                        </div>
                        <div class="form-group">
                            <label>Miktar *</label>
                            <input type="number" id="tesisMiktar" placeholder="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Birim *</label>
                            <select id="tesisBirim" required>
                                <option value="">SeÃ§iniz</option>
                                <option value="Litre">Litre</option>
                                <option value="Kg">Kg</option>
                                <option value="Adet">Adet</option>
                                <option value="Ton">Ton</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>GeldiÄŸi Yer *</label>
                            <input type="text" id="tesisNereden" placeholder="Åehir/Firma" required>
                        </div>
                        <div class="form-group">
                            <label>GideceÄŸi Yer *</label>
                            <input type="text" id="tesisNereye" placeholder="Åehir/Firma" required>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="tesisKaydet()">âœ… Kaydet</button>
                    <button class="btn btn-warning" onclick="tesisSifirla()">ğŸ”„ Temizle</button>
                </div>

                <div class="form-section">
                    <h3>ğŸ“‹ Tesis GiriÅŸ/Ã‡Ä±kÄ±ÅŸ Listesi</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tarih/Saat</th>
                                    <th>Ä°ÅŸlem</th>
                                    <th>Plaka</th>
                                    <th>ÅofÃ¶r</th>
                                    <th>ÃœrÃ¼n</th>
                                    <th>Miktar</th>
                                    <th>Nereden</th>
                                    <th>Nereye</th>
                                    <th>Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="tesisTable">
                                <tr><td colspan="9" style="text-align: center; color: #6c757d;">HenÃ¼z kayÄ±t yok</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="arac" class="tab-content">
                <div class="form-section">
                    <h3>â›½ AraÃ§ YakÄ±t Takibi KaydÄ±</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tarih *</label>
                            <input type="date" id="aracTarih" required>
                        </div>
                        <div class="form-group">
                            <label>AraÃ§ SeÃ§imi *</label>
                            <select id="aracSecim" onchange="aracSecimDegisti()" required>
                                <option value="">SeÃ§iniz</option>
                                <option value="manuel">ğŸ“ Manuel GiriÅŸ</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="aracPlakaManuelDiv">
                            <label>AraÃ§ PlakasÄ± (Manuel) *</label>
                            <input type="text" id="aracPlakaManuel" placeholder="34 ABC 123">
                        </div>
                        <div class="form-group">
                            <label>ÅofÃ¶r *</label>
                            <input type="text" id="aracSofor" placeholder="ÅofÃ¶r AdÄ±" required>
                        </div>
                        <div class="form-group">
                            <label>BaÅŸlangÄ±Ã§ Km *</label>
                            <input type="number" id="aracBasKm" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label>BaÅŸlangÄ±Ã§ YakÄ±t (Lt) *</label>
                            <input type="number" id="aracBasYakit" placeholder="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Eklenen YakÄ±t (Lt)</label>
                            <input type="number" id="aracEklenenYakit" placeholder="0" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>YakÄ±t Eklenme Km</label>
                            <input type="number" id="aracYakitKm" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>TÃ¼ketilen YakÄ±t (Lt) *</label>
                            <input type="number" id="aracSonYakit" placeholder="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Sefer Sonu Km *</label>
                            <input type="number" id="aracSonKm" placeholder="0" required>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="aracKaydet()">âœ… Kaydet</button>
                    <button class="btn btn-warning" onclick="aracSifirla()">ğŸ”„ Temizle</button>
                </div>

                <div class="form-section">
                    <h3>ğŸ“‹ AraÃ§ YakÄ±t Takip Listesi</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Plaka</th>
                                    <th>ÅofÃ¶r</th>
                                    <th>BaÅŸ. Km</th>
                                    <th>BaÅŸ. YakÄ±t</th>
                                    <th>Eklenen</th>
                                    <th>Top. YakÄ±t</th>
                                    <th>TÃ¼ketilen</th>
                                    <th>Son Km</th>
                                    <th>Kat. Km</th>
                                    <th>Sarfiyat</th>
                                    <th>Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="aracTable">
                                <tr><td colspan="12" style="text-align: center; color: #6c757d;">HenÃ¼z kayÄ±t yok</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="personel" class="tab-content">
                <div class="form-section">
                    <h3>ğŸ‘¤ Personel Bilgileri KaydÄ±</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Personel AdÄ± SoyadÄ± *</label>
                            <input type="text" id="personelAd" placeholder="Personel AdÄ±" required>
                        </div>
                        <div class="form-group">
                            <label>TC Kimlik No</label>
                            <input type="text" id="personelTC" placeholder="12345678901" maxlength="11">
                        </div>
                        <div class="form-group">
                            <label>Telefon</label>
                            <input type="tel" id="personelTel" placeholder="0555 555 55 55">
                        </div>
                        <div class="form-group">
                            <label>GÃ¶rev</label>
                            <input type="text" id="personelGorev" placeholder="Ã–r: ÅofÃ¶r, Memur">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="personelKaydet()">âœ… Personel Kaydet</button>
                    <button class="btn btn-warning" onclick="personelSifirla()">ğŸ”„ Temizle</button>
                </div>

                <div class="form-section">
                    <h3>ğŸ“‹ Personel Listesi</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>TC</th>
                                    <th>Telefon</th>
                                    <th>GÃ¶rev</th>
                                    <th>Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="personelListTable">
                                <tr><td colspan="5" style="text-align: center; color: #6c757d;">HenÃ¼z personel kaydÄ± yok</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ“… Personel GÃ¼nlÃ¼k Devam KaydÄ±</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tarih *</label>
                            <input type="date" id="devamTarih" required>
                        </div>
                        <div class="form-group">
                            <label>Personel *</label>
                            <select id="devamPersonel" required>
                                <option value="">SeÃ§iniz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>GiriÅŸ Saati</label>
                            <input type="time" id="devamGiris">
                        </div>
                        <div class="form-group">
                            <label>Ã‡Ä±kÄ±ÅŸ Saati</label>
                            <input type="time" id="devamCikis">
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="devamIzinli"> Ä°zinli</label>
                        <label><input type="checkbox" id="devamRaporlu"> Raporlu</label>
                        <label><input type="checkbox" id="devamGorevde" onchange="toggleGorevYeri()"> GÃ¶revde</label>
                    </div>
                    <div class="form-group hidden" id="gorevYeriDiv" style="margin-top: 15px;">
                        <label>GÃ¶rev Yeri *</label>
                        <input type="text" id="devamGorevYeri" placeholder="GÃ¶rev yeri giriniz">
                    </div>
                    <button class="btn btn-primary" onclick="devamKaydet()" style="margin-top: 15px;">âœ… Devam Kaydet</button>
                </div>

                <div class="form-section">
                    <h3>ğŸ“‹ Personel Devam Listesi</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Personel</th>
                                    <th>GiriÅŸ</th>
                                    <th>Ã‡Ä±kÄ±ÅŸ</th>
                                    <th>Ã‡alÄ±ÅŸma SÃ¼resi</th>
                                    <th>Durum</th>
                                    <th>Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="devamTable">
                                <tr><td colspan="7" style="text-align: center; color: #6c757d;">HenÃ¼z devam kaydÄ± yok</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="giderler" class="tab-content">
                <div class="form-section">
                    <h3>ğŸ’¸ Gider KaydÄ±</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tarih *</label>
                            <input type="date" id="giderTarih" required>
                        </div>
                        <div class="form-group">
                            <label>Gider TÃ¼rÃ¼ *</label>
                            <select id="giderTur" required>
                                <option value="">SeÃ§iniz</option>
                                <option value="Mutfak MasrafÄ±">Mutfak MasrafÄ±</option>
                                <option value="KÄ±rtasiye MasrafÄ±">KÄ±rtasiye MasrafÄ±</option>
                                <option value="Malzeme AlÄ±mÄ±">Malzeme AlÄ±mÄ±</option>
                                <option value="BakÄ±m/OnarÄ±m">BakÄ±m/OnarÄ±m</option>
                                <option value="Tamir Ãœcreti">Tamir Ãœcreti</option>
                                <option value="YakÄ±t">YakÄ±t</option>
                                <option value="Personel MaaÅŸÄ±">Personel MaaÅŸÄ±</option>
                                <option value="Elektrik">Elektrik</option>
                                <option value="Su">Su</option>
                                <option value="DiÄŸer">DiÄŸer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tutar (â‚º) *</label>
                            <input type="number" id="giderTutar" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>AÃ§Ä±klama</label>
                            <textarea id="giderAciklama" rows="1" placeholder="Detay aÃ§Ä±klama..."></textarea>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="giderKaydet()">âœ… Gider Kaydet</button>
                    <button class="btn btn-warning" onclick="giderSifirla()">ğŸ”„ Temizle</button>
                </div>

                <div class="form-section">
                    <h3>ğŸ“‹ Gider Listesi</h3>
                    <div class="summary-grid" style="margin-bottom: 20px;">
                        <div class="summary-item gider">
                            <label>Toplam Gider</label>
                            <div class="value" id="toplamGider">0 â‚º</div>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Gider TÃ¼rÃ¼</th>
                                    <th>Tutar</th>
                                    <th>AÃ§Ä±klama</th>
                                    <th>Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="giderTable">
                                <tr><td colspan="5" style="text-align: center; color: #6c757d;">HenÃ¼z gider kaydÄ± yok</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="gelirler" class="tab-content">
                <div class="form-section">
                    <h3>ğŸ’° Gelir KaydÄ±</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tarih *</label>
                            <input type="date" id="gelirTarih" required>
                        </div>
                        <div class="form-group">
                            <label>Gelir TÃ¼rÃ¼ *</label>
                            <select id="gelirTur" required>
                                <option value="">SeÃ§iniz</option>
                                <option value="Nakliye Ãœcreti">Nakliye Ãœcreti</option>
                                <option value="Ambar KirasÄ±">Ambar KirasÄ±</option>
                                <option value="ÃœrÃ¼n SatÄ±ÅŸÄ±">ÃœrÃ¼n SatÄ±ÅŸÄ±</option>
                                <option value="Hizmet Bedeli">Hizmet Bedeli</option>
                                <option value="DiÄŸer">DiÄŸer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>MÃ¼ÅŸteri/Firma *</label>
                            <input type="text" id="gelirMusteri" placeholder="Firma AdÄ±" required>
                        </div>
                        <div class="form-group">
                            <label>Tutar (â‚º) *</label>
                            <input type="number" id="gelirTutar" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>AÃ§Ä±klama</label>
                            <textarea id="gelirAciklama" rows="1" placeholder="Detay aÃ§Ä±klama..."></textarea>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="gelirKaydet()">âœ… Gelir Kaydet</button>
                    <button class="btn btn-warning" onclick="gelirSifirla()">ğŸ”„ Temizle</button>
                </div>

                <div class="form-section">
                    <h3>ğŸ“‹ Gelir Listesi</h3>
                    <div class="summary-grid" style="margin-bottom: 20px;">
                        <div class="summary-item gelir">
                            <label>Toplam Gelir</label>
                            <div class="value" id="toplamGelir">0 â‚º</div>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Gelir TÃ¼rÃ¼</th>
                                    <th>MÃ¼ÅŸteri/Firma</th>
                                    <th>Tutar</th>
                                    <th>AÃ§Ä±klama</th>
                                    <th>Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="gelirTable">
                                <tr><td colspan="6" style="text-align: center; color: #6c757d;">HenÃ¼z gelir kaydÄ± yok</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="kasa" class="tab-content">
                <div class="kasa-display">
                    <h3 style="margin-bottom: 5px;">ğŸ’° GÃœNCEL KASA BAKÄ°YESÄ°</h3>
                    <h2 id="kasaBakiye">0.00 â‚º</h2>
                    <p style="opacity: 0.9;">Son gÃ¼ncelleme: <span id="kasaGuncelleme">-</span></p>
                </div>

                <div class="form-section">
                    <h3>ğŸ¦ AÃ§Ä±lÄ±ÅŸ Bakiyesi Belirle</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>AÃ§Ä±lÄ±ÅŸ Bakiyesi (â‚º) *</label>
                            <input type="number" id="kasaAcilis" placeholder="0.00" step="0.01">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="kasaAcilisKaydet()">âœ… AÃ§Ä±lÄ±ÅŸ Bakiyesi Kaydet</button>
                    <p style="margin-top: 10px; color: #6c757d; font-size: 13px;">
                        âš ï¸ Not: Bu deÄŸer, mevcut tÃ¼m gelir ve giderlerin Ã¼zerine eklenir.
                    </p>
                </div>

                <div class="summary-grid">
                    <div class="summary-item gelir">
                        <label>Toplam Gelir</label>
                        <div class="value" id="kasaToplamGelir">0 â‚º</div>
                    </div>
                    <div class="summary-item gider">
                        <label>Toplam Gider</label>
                        <div class="value" id="kasaToplamGider">0 â‚º</div>
                    </div>
                    <div class="summary-item">
                        <label>Net Kar/Zarar</label>
                        <div class="value" id="kasaNetKar">0 â‚º</div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ“‹ Kasa Hareketleri</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Ä°ÅŸlem TÃ¼rÃ¼</th>
                                    <th>Kategori</th>
                                    <th>AÃ§Ä±klama</th>
                                    <th>Gelir</th>
                                    <th>Gider</th>
                                    <th>Bakiye</th>
                                </tr>
                            </thead>
                            <tbody id="kasaHareketTable">
                                <tr><td colspan="7" style="text-align: center; color: #6c757d;">HenÃ¼z iÅŸlem yok</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="raporlar" class="tab-content">
                <div class="filter-section">
                    <h4>ğŸ“… Rapor Filtresi</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>BaÅŸlangÄ±Ã§ Tarihi</label>
                            <input type="date" id="raporBasTarih">
                        </div>
                        <div class="form-group">
                            <label>BitiÅŸ Tarihi</label>
                            <input type="date" id="raporBitTarih">
                        </div>
                        <div class="form-group">
                            <label>Rapor TÃ¼rÃ¼</label>
                            <select id="raporTur">
                                <option value="tesis">Tesis GiriÅŸ/Ã‡Ä±kÄ±ÅŸ</option>
                                <option value="arac">AraÃ§ YakÄ±t Sarfiyat</option>
                                <option value="personel">Personel Devam</option>
                                <option value="gelir">Gelir</option>
                                <option value="gider">Gider</option>
                                <option value="kasa">Kasa Ã–zet</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="raporOlustur()">ğŸ“Š Rapor OluÅŸtur</button>
                    <button class="btn btn-success" onclick="raporIndir()">ğŸ’¾ Excel Ä°ndir</button>
                </div>

                <div id="raporSonuc" class="report-section" style="display: none;">
                    <h4>ğŸ“‹ Rapor SonuÃ§larÄ±</h4>
                    <div id="raporIcerik"></div>
                </div>
            </div>

            <div id="ayarlar" class="tab-content">
                <div class="form-section">
                    <h3>ğŸš— AraÃ§ YÃ¶netimi</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>AraÃ§ PlakasÄ± *</label>
                            <input type="text" id="yeniAracPlaka" placeholder="34 ABC 123">
                        </div>
                        <div class="form-group">
                            <label>Marka/Model</label>
                            <input type="text" id="yeniAracModel" placeholder="Ford Transit">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="aracEkle()">â• AraÃ§ Ekle</button>
                </div>

                <div class="form-section">
                    <h3>ğŸ“‹ KayÄ±tlÄ± AraÃ§lar</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Plaka</th>
                                    <th>Marka/Model</th>
                                    <th>Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="aracListTable">
                                <tr><td colspan="3" style="text-align: center; color: #6c757d;">HenÃ¼z araÃ§ kaydÄ± yok</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ’¾ Veri YÃ¶netimi</h3>
                    <p style="margin-top: 15px; color: #6c757d; font-size: 13px;">
                        Verileriniz artÄ±k Supabase veritabanÄ±nda gÃ¼vende. Yedekleme ve veri silme iÅŸlemlerini Supabase paneliniz Ã¼zerinden yapmalÄ±sÄ±nÄ±z.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =======================================================
        // SUPABASE BAÄLANTISI
        // =======================================================
        const SUPABASE_URL = 'https://axjkmikillicvvwtaart.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4amttaWtpbGxpY3Z2d3RhYXJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyOTIyMzEsImV4cCI6MjA3Nzg2ODIzMX0.7qhrV3_g8W0082TzzSrhKSh6z7g0o33tXIMdYb1jFLg';

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        console.log('Supabase istemcisi baÅŸlatÄ±ldÄ±.');

        // =======================================================
        // YARDIMCI FONKSÄ°YONLAR
        // =======================================================

        // Spinner (YÃ¼kleniyor) GÃ¶ster/Gizle
        function showSpinner() {
            document.getElementById('spinnerOverlay').style.display = 'flex';
        }
        function hideSpinner() {
            document.getElementById('spinnerOverlay').style.display = 'none';
        }

        // Genel Supabase Hata GÃ¶sterici
        function handleSupabaseError(error, context) {
            console.error(`Supabase HatasÄ± (${context}):`, error.message);
            alert(`Bir hata oluÅŸtu (${context}): ${error.message}`);
            hideSpinner();
        }

        // =======================================================
        // YENÄ° TABLO Ä°SÄ°MLERÄ° (Supabase'deki gibi)
        // =======================================================
        const TABLO = {
            TESIS: 'tesis',
            ARAC_YAKIT: 'arac_yakit',
            PERSONEL: 'personel',
            PERSONEL_DEVAM: 'personel_devam',
            GIDERLER: 'giderler',
            GELIRLER: 'gelirler',
            ARAC_LISTESI: 'arac_listesi',
            KASA_AYARLARI: 'kasa_ayarlari' // Kasa aÃ§Ä±lÄ±ÅŸ bakiyesi iÃ§in
        };


        // =======================================================
        // GENEL UYGULAMA MANTIÄI
        // =======================================================

        // Sekme deÄŸiÅŸtirme
        async function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            tabs.forEach(tab => {
                if(tab.textContent.includes(getTabLabel(tabName))) {
                    tab.classList.add('active');
                }
            });
            
            document.getElementById(tabName).classList.add('active');

            // Sekme deÄŸiÅŸtiÄŸinde verileri ASENKRON olarak yenile
            showSpinner();
            try {
                if (tabName === 'dashboard') await dashboardGuncelle();
                if (tabName === 'tesis') await tesisListele();
                if (tabName === 'arac') { await aracListele(); await aracSelectDoldur(); }
                if (tabName === 'personel') { await personelListele(); await devamListele(); await personelSelectDoldur(); }
                if (tabName === 'giderler') await giderListele();
                if (tabName === 'gelirler') await gelirListele();
                if (tabName === 'kasa') await kasaGuncelle();
                if (tabName === 'ayarlar') await aracListesiGoster();
            } catch (error) {
                console.error('Sekme yÃ¼klenirken hata:', error);
            } finally {
                hideSpinner();
            }
        }

        function getTabLabel(tabName) {
            const labels = {
                'dashboard': 'Dashboard',
                'tesis': 'Tesis',
                'arac': 'AraÃ§',
                'personel': 'Personel',
                'giderler': 'Giderler',
                'gelirler': 'Gelirler',
                'kasa': 'Kasa',
                'raporlar': 'Raporlar',
                'ayarlar': 'Ayarlar'
            };
            return labels[tabName] || tabName;
        }

        // Sayfa yÃ¼klendiÄŸinde
        window.onload = async function() {
            console.log('Sayfa yÃ¼klendi');
            // BugÃ¼nÃ¼n tarihini ayarla
            const bugun = new Date().toISOString().split('T')[0];
            const simdikiZaman = new Date().toISOString().slice(0, 16);
            
            document.getElementById('tesisTarih').value = simdikiZaman;
            document.getElementById('aracTarih').value = bugun;
            document.getElementById('devamTarih').value = bugun;
            document.getElementById('giderTarih').value = bugun;
            document.getElementById('gelirTarih').value = bugun;
            document.getElementById('raporBasTarih').value = bugun;
            document.getElementById('raporBitTarih').value = bugun;

            showSpinner();
            try {
                // Sadece aktif olan (dashboard) ve 
                // ortak kullanÄ±lan (select) verileri Ã§ek
                await dashboardGuncelle();
                await aracSelectDoldur();
                await personelSelectDoldur();
                // await aracListesiGoster(); // Ayarlar'a tÄ±klanmadÄ±kÃ§a gerek yok
            } catch (error) {
                console.error('Ä°lk yÃ¼kleme hatasÄ±:', error);
            } finally {
                hideSpinner();
                console.log('Sayfa hazÄ±r!');
            }
        };

        // =======================================================
        // DASHBOARD FONKSÄ°YONLARI
        // =======================================================
        async function dashboardGuncelle() {
            console.log('Dashboard gÃ¼ncelleniyor...');
            const bugun = new Date().toISOString().split('T')[0];
            const ay = new Date().toISOString().slice(0, 7);

            try {
                // Tesis giriÅŸ/Ã§Ä±kÄ±ÅŸ sayÄ±sÄ± (bugÃ¼n)
                const { count: tesisCount, error: tesisError } = await _supabase
                    .from(TABLO.TESIS)
                    .select('*', { count: 'exact', head: true })
                    .gte('tarih', `${bugun}T00:00:00`)
                    .lte('tarih', `${bugun}T23:59:59`);
                if(tesisError) throw tesisError;
                document.getElementById('dashTesisCount').textContent = tesisCount || 0;

                // Kasa bakiyesi (Hesaplama)
                const { data: gelirData, error: gelirError } = await _supabase.from(TABLO.GELIRLER).select('tutar');
                if(gelirError) throw gelirError;
                const { data: giderData, error: giderError } = await _supabase.from(TABLO.GIDERLER).select('tutar');
                if(giderError) throw giderError;
                const { data: kasaAyar, error: ayarError } = await _supabase.from(TABLO.KASA_AYARLARI).select('acilis_bakiyesi').eq('id', 1).maybeSingle();
                if(ayarError) throw ayarError;
                
                const toplamGelir = gelirData.reduce((sum, g) => sum + parseFloat(g.tutar || 0), 0);
                const toplamGider = giderData.reduce((sum, g) => sum + parseFloat(g.tutar || 0), 0);
                const acilisBakiyesi = kasaAyar ? parseFloat(kasaAyar.acilis_bakiyesi || 0) : 0;
                const kasaBakiye = acilisBakiyesi + toplamGelir - toplamGider;
                
                document.getElementById('dashKasa').textContent = kasaBakiye.toFixed(2) + ' â‚º';

                // AraÃ§ sayÄ±sÄ±
                const { count: aracCount, error: aracError } = await _supabase.from(TABLO.ARAC_LISTESI).select('*', { count: 'exact', head: true });
                if(aracError) throw aracError;
                document.getElementById('dashAracCount').textContent = aracCount || 0;

                // Personel sayÄ±sÄ±
                const { count: personelCount, error: pError } = await _supabase.from(TABLO.PERSONEL).select('*', { count: 'exact', head: true });
                if(pError) throw pError;
                document.getElementById('dashPersonelCount').textContent = personelCount || 0;

                // BugÃ¼nkÃ¼ gelir/gider
                const { data: bugunGelirData, error: bgError } = await _supabase.from(TABLO.GELIRLER).select('tutar').eq('tarih', bugun);
                if(bgError) throw bgError;
                const { data: bugunGiderData, error: bggError } = await _supabase.from(TABLO.GIDERLER).select('tutar').eq('tarih', bugun);
                if(bggError) throw bggError;

                const bugunGelir = bugunGelirData.reduce((sum, g) => sum + parseFloat(g.tutar || 0), 0);
                const bugunGider = bugunGiderData.reduce((sum, g) => sum + parseFloat(g.tutar || 0), 0);

                document.getElementById('dashBugunGelir').textContent = bugunGelir.toFixed(2) + ' â‚º';
                document.getElementById('dashBugunGider').textContent = bugunGider.toFixed(2) + ' â‚º';

                // AylÄ±k gelir/gider
                const { data: aylikGelirData, error: agError } = await _supabase.from(TABLO.GELIRLER).select('tutar').like('tarih', `${ay}-%`);
                if(agError) throw agError;
                const { data: aylikGiderData, error: aggError } = await _supabase.from(TABLO.GIDERLER).select('tutar').like('tarih', `${ay}-%`);
                if(aggError) throw aggError;
                
                const aylikGelir = aylikGelirData.reduce((sum, g) => sum + parseFloat(g.tutar || 0), 0);
                const aylikGider = aylikGiderData.reduce((sum, g) => sum + parseFloat(g.tutar || 0), 0);

                document.getElementById('dashAylikGelir').textContent = aylikGelir.toFixed(2) + ' â‚º';
                document.getElementById('dashAylikGider').textContent = aylikGider.toFixed(2) + ' â‚º';
            } catch (error) {
                handleSupabaseError(error, 'Dashboard GÃ¼ncelleme');
            }
        }

        // =======================================================
        // TESÄ°S GÄ°RÄ°Å/Ã‡IKIÅ FONKSÄ°YONLARI
        // =======================================================
        async function tesisKaydet() {
            console.log('Tesis kaydet Ã§alÄ±ÅŸtÄ±');
            showSpinner();
            const tarih = document.getElementById('tesisTarih').value;
            const islem = document.getElementById('tesisIslem').value;
            const plaka = document.getElementById('tesisPlaka').value;
            const sofor = document.getElementById('tesisSofor').value;
            const urun = document.getElementById('tesisUrun').value;
            const miktar = document.getElementById('tesisMiktar').value;
            const birim = document.getElementById('tesisBirim').value;
            const nereden = document.getElementById('tesisNereden').value;
            const nereye = document.getElementById('tesisNereye').value;

            if (!tarih || !islem || !plaka || !sofor || !urun || !miktar || !birim || !nereden || !nereye) {
                alert('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun!');
                hideSpinner();
                return;
            }

            const { error } = await _supabase.from(TABLO.TESIS).insert({
                tarih, islem, plaka, sofor, urun, miktar, birim, nereden, nereye
            });
            
            if (error) {
                hideSpinner();
                handleSupabaseError(error, 'Tesis Kaydet');
            } else {
                alert('âœ… Tesis giriÅŸ/Ã§Ä±kÄ±ÅŸ kaydÄ± baÅŸarÄ±yla eklendi!');
                tesisSifirla();
                await tesisListele(); // Listeyi yenile
                await dashboardGuncelle();
                hideSpinner(); // Her ÅŸey bitince spinner'Ä± gizle
            }
        }

        function tesisSifirla() {
            document.getElementById('tesisTarih').value = new Date().toISOString().slice(0, 16);
            document.getElementById('tesisIslem').value = '';
            document.getElementById('tesisPlaka').value = '';
            document.getElementById('tesisSofor').value = '';
            document.getElementById('tesisUrun').value = '';
            document.getElementById('tesisMiktar').value = '';
            document.getElementById('tesisBirim').value = '';
            document.getElementById('tesisNereden').value = '';
            document.getElementById('tesisNereye').value = '';
        }

        async function tesisListele() {
            // showSpinner(); // Zaten showTab iÃ§inde Ã§aÄŸrÄ±lÄ±yor
            const { data, error } = await _supabase
                .from(TABLO.TESIS)
                .select('*')
                .order('tarih', { ascending: false }); // En yeni en Ã¼stte

            // hideSpinner(); // showTab sonunda gizlenecek
            if (error) return handleSupabaseError(error, 'Tesis Listele');

            const tbody = document.getElementById('tesisTable');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #6c757d;">HenÃ¼z kayÄ±t yok</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${new Date(item.tarih).toLocaleString('tr-TR')}</td>
                    <td><span style="background: ${item.islem === 'GiriÅŸ' ? '#38ef7d' : '#f5576c'}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px;">${item.islem}</span></td>
                    <td>${item.plaka}</td>
                    <td>${item.sofor}</td>
                    <td>${item.urun}</td>
                    <td>${item.miktar} ${item.birim}</td>
                    <td>${item.nereden}</td>
                    <td>${item.nereye}</td>
                    <td><button class="btn btn-danger btn-small" onclick="tesisSil(${item.id})">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
        }

        async function tesisSil(id) {
            if (!confirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz?')) return;
            showSpinner();
            const { error } = await _supabase.from(TABLO.TESIS).delete().eq('id', id);
            
            if (error) {
                hideSpinner();
                handleSupabaseError(error, 'Tesis Sil');
            } else {
                alert('KayÄ±t silindi.');
                await tesisListele();
                await dashboardGuncelle();
                hideSpinner();
            }
        }

        // =======================================================
        // ARAÃ‡ YAKIT TAKÄ°BÄ° FONKSÄ°YONLARI
        // =======================================================
        function aracSecimDegisti() {
            const secim = document.getElementById('aracSecim').value;
            const manuelDiv = document.getElementById('aracPlakaManuelDiv');
            
            if(secim === 'manuel') {
                manuelDiv.classList.remove('hidden');
            } else {
                manuelDiv.classList.add('hidden');
            }
        }

        async function aracKaydet() {
            console.log('AraÃ§ kaydet Ã§alÄ±ÅŸtÄ±');
            showSpinner();
            const tarih = document.getElementById('aracTarih').value;
            const secim = document.getElementById('aracSecim').value;
            
            let plaka = '';
            if(secim === 'manuel') {
                plaka = document.getElementById('aracPlakaManuel').value;
            } else if(secim && secim !== '') {
                plaka = secim;
            }
            
            const sofor = document.getElementById('aracSofor').value;
            const basKm = parseFloat(document.getElementById('aracBasKm').value);
            const basYakit = parseFloat(document.getElementById('aracBasYakit').value);
            const eklenenYakit = parseFloat(document.getElementById('aracEklenenYakit').value) || 0;
            const yakitKm = document.getElementById('aracYakitKm').value || null; // BoÅŸsa null gÃ¶nder
            const sonYakit = parseFloat(document.getElementById('aracSonYakit').value); // TÃ¼ketilen yakÄ±t
            const sonKm = parseFloat(document.getElementById('aracSonKm').value);

            if (!tarih || !plaka || !sofor || isNaN(basKm) || isNaN(basYakit) || isNaN(sonYakit) || isNaN(sonKm)) {
                alert('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun!');
                hideSpinner();
                return;
            }

            const toplamYakit = basYakit + eklenenYakit;
            const katetdigiKm = sonKm - basKm;
            const tuketimLt = sonYakit; 
            const sarfiyat = katetdigiKm > 0 ? (tuketimLt / katetdigiKm * 100).toFixed(2) : 0;
            const sarfiyatYuzde = katetdigiKm > 0 ? Math.round((tuketimLt / katetdigiKm) * 100) : 0;

            const { error } = await _supabase.from(TABLO.ARAC_YAKIT).insert({
                tarih, plaka, sofor, basKm, basYakit, eklenenYakit, yakitKm, 
                toplamYakit, sonYakit, sonKm, katetdigiKm, sarfiyat, sarfiyatYuzde
            });
            
            hideSpinner();
            if(error) {
                handleSupabaseError(error, 'AraÃ§ YakÄ±t Kaydet');
            } else {
                alert('âœ… AraÃ§ yakÄ±t takibi kaydÄ± baÅŸarÄ±yla eklendi!');
                aracSifirla();
                await aracListele();
            }
        }

        function aracSifirla() {
            document.getElementById('aracTarih').value = new Date().toISOString().split('T')[0];
            document.getElementById('aracSecim').value = '';
            document.getElementById('aracPlakaManuel').value = '';
            document.getElementById('aracPlakaManuelDiv').classList.add('hidden');
            document.getElementById('aracSofor').value = '';
            document.getElementById('aracBasKm').value = '';
            document.getElementById('aracBasYakit').value = '';
            document.getElementById('aracEklenenYakit').value = '0';
            document.getElementById('aracYakitKm').value = '';
            document.getElementById('aracSonYakit').value = '';
            document.getElementById('aracSonKm').value = '';
        }

        async function aracListele() {
            const { data, error } = await _supabase
                .from(TABLO.ARAC_YAKIT)
                .select('*')
                .order('tarih', { ascending: false });
            
            if (error) return handleSupabaseError(error, 'AraÃ§ YakÄ±t Listele');

            const tbody = document.getElementById('aracTable');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; color: #6c757d;">HenÃ¼z kayÄ±t yok</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.tarih}</td>
                    <td>${item.plaka}</td>
                    <td>${item.sofor}</td>
                    <td>${item.basKm}</td>
                    <td>${item.basYakit} Lt</td>
                    <td>${item.eklenenYakit} Lt</td>
                    <td>${item.toplamYakit.toFixed(2)} Lt</td>
                    <td>${item.sonYakit} Lt</td>
                    <td>${item.sonKm}</td>
                    <td><strong>${item.katetdigiKm} Km</strong></td>
                    <td><span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px;">${item.sarfiyat} Lt/100Km = %${item.sarfiyatYuzde || Math.round(item.sarfiyat)}</span></td>
                    <td><button class="btn btn-danger btn-small" onclick="aracSil(${item.id})">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
        }

        async function aracSil(id) {
            if (!confirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz?')) return;
            showSpinner();
            const { error } = await _supabase.from(TABLO.ARAC_YAKIT).delete().eq('id', id);
            
            hideSpinner();
            if (error) {
                handleSupabaseError(error, 'AraÃ§ YakÄ±t Sil');
            } else {
                alert('KayÄ±t silindi.');
                await aracListele();
            }
        }

        async function aracSelectDoldur() {
            const { data, error } = await _supabase.from(TABLO.ARAC_LISTESI).select('plaka, model');
            
            if (error) return handleSupabaseError(error, 'AraÃ§ Listesi Ã‡ekme');

            const select = document.getElementById('aracSecim');
            
            let html = '<option value="">SeÃ§iniz</option>';
            html += '<option value="manuel">ğŸ“ Manuel GiriÅŸ</option>';
            
            data.forEach(arac => {
                html += `<option value="${arac.plaka}">${arac.plaka}${arac.model ? ' - ' + arac.model : ''}</option>`;
            });
            
            select.innerHTML = html;
        }

        // =======================================================
        // PERSONEL TAKÄ°P FONKSÄ°YONLARI
        // =======================================================
        async function personelKaydet() {
            console.log('Personel kaydet Ã§alÄ±ÅŸtÄ±');
            showSpinner();
            const ad = document.getElementById('personelAd').value.trim();
            const tc = document.getElementById('personelTC').value.trim() || null;
            const tel = document.getElementById('personelTel').value.trim() || null;
            const gorev = document.getElementById('personelGorev').value.trim() || null;

            if (!ad) {
                alert('LÃ¼tfen personel adÄ±nÄ± giriniz!');
                hideSpinner();
                return;
            }

            const { error } = await _supabase.from(TABLO.PERSONEL).insert({
                ad, tc, tel, gorev
            });
            
            hideSpinner();
            if(error) {
                handleSupabaseError(error, 'Personel Kaydet');
            } else {
                alert('âœ… Personel kaydÄ± baÅŸarÄ±yla eklendi!');
                personelSifirla();
                await personelListele();
                await personelSelectDoldur();
                await dashboardGuncelle();
            }
        }

        function personelSifirla() {
            document.getElementById('personelAd').value = '';
            document.getElementById('personelTC').value = '';
            document.getElementById('personelTel').value = '';
            document.getElementById('personelGorev').value = '';
        }

        async function personelListele() {
            const { data, error } = await _supabase.from(TABLO.PERSONEL).select('*');
            if (error) return handleSupabaseError(error, 'Personel Listele');

            const tbody = document.getElementById('personelListTable');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d;">HenÃ¼z personel kaydÄ± yok</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.ad}</td>
                    <td>${item.tc || '-'}</td>
                    <td>${item.tel || '-'}</td>
                    <td>${item.gorev || '-'}</td>
                    <td><button class="btn btn-danger btn-small" onclick="personelSil(${item.id})">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
        }

        async function personelSil(id) {
            if (!confirm('Bu personeli silmek istediÄŸinizden emin misiniz?')) return;
            showSpinner();
            const { error } = await _supabase.from(TABLO.PERSONEL).delete().eq('id', id);

            hideSpinner();
            if (error) {
                handleSupabaseError(error, 'Personel Sil');
            } else {
                alert('Personel silindi.');
                await personelListele();
                await personelSelectDoldur();
                await dashboardGuncelle();
            }
        }

        async function personelSelectDoldur() {
            const { data, error } = await _supabase.from(TABLO.PERSONEL).select('ad');

            if (error) return handleSupabaseError(error, 'Personel Select Doldur');

            const select = document.getElementById('devamPersonel');
            select.innerHTML = '<option value="">SeÃ§iniz</option>' + 
                data.map(p => `<option value="${p.ad}">${p.ad}</option>`).join('');
        }

        function toggleGorevYeri() {
            const gorevdeCheckbox = document.getElementById('devamGorevde');
            const gorevYeriDiv = document.getElementById('gorevYeriDiv');
            
            if (gorevdeCheckbox.checked) {
                gorevYeriDiv.classList.remove('hidden');
            } else {
                gorevYeriDiv.classList.add('hidden');
                document.getElementById('devamGorevYeri').value = '';
            }
        }

        async function devamKaydet() {
            console.log('Devam kaydet Ã§alÄ±ÅŸtÄ±');
            showSpinner();
            const tarih = document.getElementById('devamTarih').value;
            const personel = document.getElementById('devamPersonel').value;
            const giris = document.getElementById('devamGiris').value || null;
            const cikis = document.getElementById('devamCikis').value || null;
            const izinli = document.getElementById('devamIzinli').checked;
            const raporlu = document.getElementById('devamRaporlu').checked;
            const gorevde = document.getElementById('devamGorevde').checked;
            const gorevYeri = document.getElementById('devamGorevYeri').value || null;

            if (!tarih || !personel) {
                alert('LÃ¼tfen tarih ve personel seÃ§iniz!');
                hideSpinner();
                return;
            }

            let durum = 'Ã‡alÄ±ÅŸtÄ±';
            if (izinli) durum = 'Ä°zinli';
            if (raporlu) durum = 'Raporlu';
            if (gorevde) durum = `GÃ¶revde (${gorevYeri || 'Bilinmiyor'})`;

            let calismaSuresi = '-';
            if (giris && cikis && !izinli && !raporlu) {
                try {
                    const girisTime = new Date(`2000-01-01T${giris}`);
                    const cikisTime = new Date(`2000-01-01T${cikis}`);
                    const diff = (cikisTime - girisTime) / 1000 / 60 / 60; // saat
                    if (diff < 0) {
                        alert("Ã‡Ä±kÄ±ÅŸ saati, giriÅŸ saatinden Ã¶nce olamaz!");
                        hideSpinner();
                        return;
                    }
                    calismaSuresi = diff.toFixed(1) + ' saat';
                } catch(e) {
                    console.error("Saat hesaplama hatasÄ±", e);
                    calismaSuresi = 'HatalÄ± Saat';
                }
            }

            const { error } = await _supabase.from(TABLO.PERSONEL_DEVAM).insert({
                tarih, personel, giris, cikis, durum, calismaSuresi
            });
            
            hideSpinner();
            if(error) {
                handleSupabaseError(error, 'Personel Devam Kaydet');
            } else {
                alert('âœ… Personel devam kaydÄ± baÅŸarÄ±yla eklendi!');
                devamSifirla();
                await devamListele();
            }
        }

        function devamSifirla() {
            document.getElementById('devamTarih').value = new Date().toISOString().split('T')[0];
            document.getElementById('devamPersonel').value = '';
            document.getElementById('devamGiris').value = '';
            document.getElementById('devamCikis').value = '';
            document.getElementById('devamIzinli').checked = false;
            document.getElementById('devamRaporlu').checked = false;
            document.getElementById('devamGorevde').checked = false;
            document.getElementById('gorevYeriDiv').classList.add('hidden');
            document.getElementById('devamGorevYeri').value = '';
        }

        async function devamListele() {
            const { data, error } = await _supabase
                .from(TABLO.PERSONEL_DEVAM)
                .select('*')
                .order('tarih', { ascending: false });
            
            if (error) return handleSupabaseError(error, 'Personel Devam Listele');

            const tbody = document.getElementById('devamTable');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6c757d;">HenÃ¼z devam kaydÄ± yok</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.tarih}</td>
                    <td>${item.personel}</td>
                    <td>${item.giris || '-'}</td>
                    <td>${item.cikis || '-'}</td>
                    <td>${item.calismaSuresi}</td>
                    <td><span style="background: ${item.durum.includes('Ä°zinli') ? '#f5576c' : item.durum.includes('Raporlu') ? '#fa709a' : item.durum.includes('GÃ¶revde') ? '#4facfe' : '#38ef7d'}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px;">${item.durum}</span></td>
                    <td><button class="btn btn-danger btn-small" onclick="devamSil(${item.id})">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
        }

        async function devamSil(id) {
            if (!confirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz?')) return;
            showSpinner();
            const { error } = await _supabase.from(TABLO.PERSONEL_DEVAM).delete().eq('id', id);
            
            hideSpinner();
            if (error) {
                handleSupabaseError(error, 'Personel Devam Sil');
            } else {
                alert('KayÄ±t silindi.');
                await devamListele();
            }
        }

        // =======================================================
        // GÄ°DER FONKSÄ°YONLARI
        // =======================================================
        async function giderKaydet() {
            console.log('Gider kaydet Ã§alÄ±ÅŸtÄ±');
            showSpinner();
            const tarih = document.getElementById('giderTarih').value;
            const tur = document.getElementById('giderTur').value;
            const tutar = parseFloat(document.getElementById('giderTutar').value);
            const aciklama = document.getElementById('giderAciklama').value || null;

            if (!tarih || !tur || isNaN(tutar) || tutar <= 0) {
                alert('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun ve geÃ§erli bir tutar girin!');
                hideSpinner();
                return;
            }

            const { error } = await _supabase.from(TABLO.GIDERLER).insert({
                tarih, tur, tutar, aciklama
            });
            
            hideSpinner();
            if(error) {
                handleSupabaseError(error, 'Gider Kaydet');
            } else {
                alert('âœ… Gider kaydÄ± baÅŸarÄ±yla eklendi!');
                giderSifirla();
                await giderListele();
                await dashboardGuncelle(); // Dashboard'u ve kasayÄ± gÃ¼nceller
            }
        }

        function giderSifirla() {
            document.getElementById('giderTarih').value = new Date().toISOString().split('T')[0];
            document.getElementById('giderTur').value = '';
            document.getElementById('giderTutar').value = '';
            document.getElementById('giderAciklama').value = '';
        }

        async function giderListele() {
            const { data, error } = await _supabase
                .from(TABLO.GIDERLER)
                .select('*')
                .order('tarih', { ascending: false });
            
            if (error) return handleSupabaseError(error, 'Gider Listele');

            const tbody = document.getElementById('giderTable');
            
            const toplam = data.reduce((sum, item) => sum + parseFloat(item.tutar || 0), 0);
            document.getElementById('toplamGider').textContent = toplam.toFixed(2) + ' â‚º';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d;">HenÃ¼z gider kaydÄ± yok</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.tarih}</td>
                    <td>${item.tur}</td>
                    <td><strong style="color: #f5576c;">${parseFloat(item.tutar).toFixed(2)} â‚º</strong></td>
                    <td>${item.aciklama || '-'}</td>
                    <td><button class="btn btn-danger btn-small" onclick="giderSil(${item.id})">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
        }

        async function giderSil(id) {
            if (!confirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz? Kasa bakiyesi gÃ¼ncellenecektir.')) return;
            
            showSpinner();
            const { error } = await _supabase.from(TABLO.GIDERLER).delete().eq('id', id);

            hideSpinner();
            if (error) {
                handleSupabaseError(error, 'Gider Sil');
            } else {
                alert('Gider kaydÄ± silindi.');
                await giderListele();
                await dashboardGuncelle();
                if(document.getElementById('kasa').classList.contains('active')) {
                    await kasaGuncelle(); // Kasa sekmesi aÃ§Ä±ksa onu da yenile
                }
            }
        }

        // =======================================================
        // GELÄ°R FONKSÄ°YONLARI
        // =======================================================
        async function gelirKaydet() {
            console.log('Gelir kaydet Ã§alÄ±ÅŸtÄ±');
            showSpinner();
            const tarih = document.getElementById('gelirTarih').value;
            const tur = document.getElementById('gelirTur').value;
            const musteri = document.getElementById('gelirMusteri').value;
            const tutar = parseFloat(document.getElementById('gelirTutar').value);
            const aciklama = document.getElementById('gelirAciklama').value || null;

            if (!tarih || !tur || !musteri || isNaN(tutar) || tutar <= 0) {
                alert('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun ve geÃ§erli bir tutar girin!');
                hideSpinner();
                return;
            }

            const { error } = await _supabase.from(TABLO.GELIRLER).insert({
                tarih, tur, musteri, tutar, aciklama
            });
            
            hideSpinner();
            if(error) {
                handleSupabaseError(error, 'Gelir Kaydet');
            } else {
                alert('âœ… Gelir kaydÄ± baÅŸarÄ±yla eklendi!');
                gelirSifirla();
                await gelirListele();
                await dashboardGuncelle();
            }
        }

        function gelirSifirla() {
            document.getElementById('gelirTarih').value = new Date().toISOString().split('T')[0];
            document.getElementById('gelirTur').value = '';
            document.getElementById('gelirMusteri').value = '';
            document.getElementById('gelirTutar').value = '';
            document.getElementById('gelirAciklama').value = '';
        }

        async function gelirListele() {
            const { data, error } = await _supabase
                .from(TABLO.GELIRLER)
                .select('*')
                .order('tarih', { ascending: false });

            if (error) return handleSupabaseError(error, 'Gelir Listele');
            
            const tbody = document.getElementById('gelirTable');
            
            const toplam = data.reduce((sum, item) => sum + parseFloat(item.tutar || 0), 0);
            document.getElementById('toplamGelir').textContent = toplam.toFixed(2) + ' â‚º';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6c757d;">HenÃ¼z gelir kaydÄ± yok</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.tarih}</td>
                    <td>${item.tur}</td>
                    <td>${item.musteri}</td>
                    <td><strong style="color: #38ef7d;">${parseFloat(item.tutar).toFixed(2)} â‚º</strong></td>
                    <td>${item.aciklama || '-'}</td>
                    <td><button class="btn btn-danger btn-small" onclick="gelirSil(${item.id})">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
        }

        async function gelirSil(id) {
            if (!confirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz? Kasa bakiyesi gÃ¼ncellenecektir.')) return;
            
            showSpinner();
            const { error } = await _supabase.from(TABLO.GELIRLER).delete().eq('id', id);

            hideSpinner();
            if (error) {
                handleSupabaseError(error, 'Gelir Sil');
            } else {
                alert('Gelir kaydÄ± silindi.');
                await gelirListele();
                await dashboardGuncelle();
                if(document.getElementById('kasa').classList.contains('active')) {
                    await kasaGuncelle(); // Kasa sekmesi aÃ§Ä±ksa onu da yenile
                }
            }
        }

        // =======================================================
        // KASA FONKSÄ°YONLARI
        // =======================================================
        async function kasaAcilisKaydet() {
            const acilis = parseFloat(document.getElementById('kasaAcilis').value);
            
            if (isNaN(acilis)) {
                alert('LÃ¼tfen geÃ§erli bir tutar giriniz!');
                return;
            }

            if (!confirm(`AÃ§Ä±lÄ±ÅŸ bakiyesi ${acilis.toFixed(2)} â‚º olarak kaydedilecek. Mevcut deÄŸerin Ã¼zerine yazÄ±lacak. OnaylÄ±yor musunuz?`)) return;

            showSpinner();
            // upsert: id=1 olan satÄ±r varsa gÃ¼ncelle, yoksa oluÅŸtur.
            const { error } = await _supabase.from(TABLO.KASA_AYARLARI).upsert(
                { id: 1, acilis_bakiyesi: acilis, guncelleme_tarih: new Date().toISOString() },
                { onConflict: 'id' }
            );

            hideSpinner();
            if (error) {
                handleSupabaseError(error, 'Kasa AÃ§Ä±lÄ±ÅŸ Kaydet');
            } else {
                alert('âœ… AÃ§Ä±lÄ±ÅŸ bakiyesi baÅŸarÄ±yla kaydedildi!');
                document.getElementById('kasaAcilis').value = '';
                await kasaGuncelle();
                await dashboardGuncelle();
            }
        }

        async function kasaGuncelle() {
            // showSpinner(); // Zaten showTab iÃ§inde
            let acilisBakiyesi = 0;
            let guncelleme = '-';
            try {
                // 1. Verileri Ã‡ek
                const { data: gelirData, error: gelirError } = await _supabase.from(TABLO.GELIRLER).select('tutar');
                if(gelirError) throw gelirError;
                const { data: giderData, error: giderError } = await _supabase.from(TABLO.GIDERLER).select('tutar');
                if(giderError) throw giderError;
                const { data: kasaAyar, error: ayarError } = await _supabase.from(TABLO.KASA_AYARLARI).select('acilis_bakiyesi, guncelleme_tarih').eq('id', 1).maybeSingle();
                if(ayarError) throw ayarError;

                // 2. HesaplamalarÄ± Yap
                const toplamGelir = gelirData.reduce((sum, g) => sum + parseFloat(g.tutar || 0), 0);
                const toplamGider = giderData.reduce((sum, g) => sum + parseFloat(g.tutar || 0), 0);
                acilisBakiyesi = kasaAyar ? parseFloat(kasaAyar.acilis_bakiyesi || 0) : 0;
                const bakiye = acilisBakiyesi + toplamGelir - toplamGider;
                guncelleme = kasaAyar ? new Date(kasaAyar.guncelleme_tarih).toLocaleString('tr-TR') : '-';
                const netKar = toplamGelir - toplamGider;

                // 3. DOM'u GÃ¼ncelle
                document.getElementById('kasaBakiye').textContent = bakiye.toFixed(2) + ' â‚º';
                document.getElementById('kasaGuncelleme').textContent = guncelleme;
                document.getElementById('kasaToplamGelir').textContent = toplamGelir.toFixed(2) + ' â‚º';
                document.getElementById('kasaToplamGider').textContent = toplamGider.toFixed(2) + ' â‚º';
                document.getElementById('kasaNetKar').textContent = netKar.toFixed(2) + ' â‚º';

                // 4. Hareket Listesini GÃ¼ncelle
                await kasaHareketListele(acilisBakiyesi); // AÃ§Ä±lÄ±ÅŸ bakiyesini parametre olarak gÃ¶nder
            } catch (error) {
                handleSupabaseError(error, 'Kasa GÃ¼ncelleme');
            }
            // hideSpinner(); // showTab sonunda
        }

        async function kasaHareketListele(acilisBakiyesi) {
            // Not: Bu fonksiyon artÄ±k kasaGuncelle iÃ§inden Ã§aÄŸrÄ±lÄ±yor.
            const { data: gelirData, error: gelirError } = await _supabase.from(TABLO.GELIRLER).select('*');
            const { data: giderData, error: giderError } = await _supabase.from(TABLO.GIDERLER).select('*');
            
            if (gelirError || giderError) {
                console.error('Kasa hareketleri Ã§ekilirken hata:', gelirError || giderError);
                return;
            }

            let hareketler = [];
            
            gelirData.forEach(g => {
                hareketler.push({
                    tarih: g.tarih,
                    tip: 'Gelir',
                    kategori: g.tur,
                    aciklama: `${g.musteri} - ${g.aciklama || ''}`,
                    gelir: parseFloat(g.tutar),
                    gider: 0
                });
            });

            giderData.forEach(g => {
                hareketler.push({
                    tarih: g.tarih,
                    tip: 'Gider',
                    kategori: g.tur,
                    aciklama: g.aciklama || '',
                    gelir: 0,
                    gider: parseFloat(g.tutar)
                });
            });

            // TARÄ°HE GÃ–RE SIRALA (Eskiden yeniye - bakiye hesabÄ± iÃ§in)
            hareketler.sort((a, b) => new Date(a.tarih) - new Date(b.tarih));

            const tbody = document.getElementById('kasaHareketTable');
            
            if (hareketler.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6c757d;">HenÃ¼z iÅŸlem yok</td></tr>';
                return;
            }

            let bakiye = acilisBakiyesi;
            
            const tableRows = hareketler.map(item => {
                if (item.tip === 'Gelir') {
                    bakiye += item.gelir;
                } else {
                    bakiye -= item.gider;
                }
                
                return `
                <tr>
                    <td>${item.tarih}</td>
                    <td><span style="background: ${item.tip === 'Gelir' ? '#38ef7d' : '#f5576c'}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px;">${item.tip}</span></td>
                    <td>${item.kategori}</td>
                    <td>${item.aciklama || '-'}</td>
                    <td style="color: #38ef7d; font-weight: bold;">${item.gelir > 0 ? item.gelir.toFixed(2) + ' â‚º' : '-'}</td>
                    <td style="color: #f5576c; font-weight: bold;">${item.gider > 0 ? item.gider.toFixed(2) + ' â‚º' : '-'}</td>
                    <td><strong>${bakiye.toFixed(2)} â‚º</strong></td>
                </tr>
            `;
            });

            // Listeyi ters Ã§evir (en yeni en Ã¼stte)
            tbody.innerHTML = tableRows.reverse().join('');
        }

        // =======================================================
        // RAPORLAR FONKSÄ°YONLARI
        // =======================================================
        async function raporOlustur() {
            showSpinner();
            const basTarih = document.getElementById('raporBasTarih').value;
            const bitTarih = document.getElementById('raporBitTarih').value;
            const tur = document.getElementById('raporTur').value;

            if (!basTarih || !bitTarih) {
                alert('LÃ¼tfen tarih aralÄ±ÄŸÄ± seÃ§iniz!');
                hideSpinner();
                return;
            }

            let html = '';

            try {
                switch(tur) {
                    case 'tesis':
                        html = await raporTesis(basTarih, bitTarih);
                        break;
                    case 'arac':
                        html = await raporArac(basTarih, bitTarih);
                        break;
                    case 'personel':
                        html = await raporPersonel(basTarih, bitTarih);
                        break;
                    case 'gelir':
                        html = await raporGelir(basTarih, bitTarih);
                        break;
                    case 'gider':
                        html = await raporGider(basTarih, bitTarih);
                        break;
                    case 'kasa':
                        html = await raporKasa(basTarih, bitTarih);
                        break;
                }
            } catch (error) {
                console.error('Rapor oluÅŸturma hatasÄ±:', error);
                html = '<p style="color: red;">Rapor oluÅŸturulurken bir hata oluÅŸtu.</p>';
            }

            document.getElementById('raporIcerik').innerHTML = html;
            document.getElementById('raporSonuc').style.display = 'block';
            hideSpinner();
        }

        async function raporTesis(basTarih, bitTarih) {
            const { data, error } = await _supabase.from(TABLO.TESIS)
                .select('*')
                .gte('tarih', `${basTarih}T00:00:00`)
                .lte('tarih', `${bitTarih}T23:59:59`)
                .order('tarih', { ascending: false });

            if (error) throw error;
            if (data.length === 0) return '<p style="color: #6c757d;">Bu tarih aralÄ±ÄŸÄ±nda kayÄ±t bulunamadÄ±.</p>';

            return `
                <h5>ğŸ“Š Tesis GiriÅŸ/Ã‡Ä±kÄ±ÅŸ Raporu (${basTarih} - ${bitTarih})</h5>
                <p><strong>Toplam Hareket:</strong> ${data.length} adet</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tarih/Saat</th>
                            <th>Ä°ÅŸlem</th>
                            <th>Plaka</th>
                            <th>ÅofÃ¶r</th>
                            <th>ÃœrÃ¼n</th>
                            <th>Miktar</th>
                            <th>Nereden</th>
                            <th>Nereye</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr>
                                <td>${new Date(item.tarih).toLocaleString('tr-TR')}</td>
                                <td>${item.islem}</td>
                                <td>${item.plaka}</td>
                                <td>${item.sofor}</td>
                                <td>${item.urun}</td>
                                <td>${item.miktar} ${item.birim}</td>
                                <td>${item.nereden}</td>
                                <td>${item.nereye}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        async function raporArac(basTarih, bitTarih) {
            const { data, error } = await _supabase.from(TABLO.ARAC_YAKIT)
                .select('*')
                .gte('tarih', basTarih)
                .lte('tarih', bitTarih)
                .order('tarih', { ascending: false });

            if (error) throw error;
            if (data.length === 0) return '<p style="color: #6c757d;">Bu tarih aralÄ±ÄŸÄ±nda kayÄ±t bulunamadÄ±.</p>';
            
            const toplamKm = data.reduce((sum, a) => sum + (a.katetdigiKm || 0), 0);
            const ortSarfiyat = data.length > 0 ? (data.reduce((sum, a) => sum + parseFloat(a.sarfiyat || 0), 0) / data.length) : 0;

            return `
                <h5>â›½ AraÃ§ YakÄ±t Sarfiyat Raporu (${basTarih} - ${bitTarih})</h5>
                <p><strong>Toplam KayÄ±t:</strong> ${data.length} adet | <strong>Toplam Km:</strong> ${toplamKm} Km | <strong>Ort. Sarfiyat:</strong> ${ortSarfiyat.toFixed(2)} Lt/100Km</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Plaka</th>
                            <th>ÅofÃ¶r</th>
                            <th>Kat. Km</th>
                            <th>TÃ¼ketim (Lt)</th>
                            <th>Sarfiyat</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr>
                                <td>${item.tarih}</td>
                                <td>${item.plaka}</td>
                                <td>${item.sofor}</td>
                                <td>${item.katetdigiKm} Km</td>
                                <td>${item.sonYakit} Lt</td>
                                <td>${item.sarfiyat} Lt/100Km</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function raporPersonel(basTarih, bitTarih) {
            const { data, error } = await _supabase.from(TABLO.PERSONEL_DEVAM)
                .select('*')
                .gte('tarih', basTarih)
                .lte('tarih', bitTarih)
                .order('tarih', { ascending: false });

            if (error) throw error;
            if (data.length === 0) return '<p style="color: #6c757d;">Bu tarih aralÄ±ÄŸÄ±nda kayÄ±t bulunamadÄ±.</p>';

            return `
                <h5>ğŸ‘¥ Personel Devam Raporu (${basTarih} - ${bitTarih})</h5>
                <p><strong>Toplam KayÄ±t:</strong> ${data.length} adet</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Personel</th>
                            <th>GiriÅŸ</th>
                            <th>Ã‡Ä±kÄ±ÅŸ</th>
                            <th>Ã‡alÄ±ÅŸma SÃ¼resi</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr>
                                <td>${item.tarih}</td>
                                <td>${item.personel}</td>
                                <td>${item.giris || '-'}</td>
                                <td>${item.cikis || '-'}</td>
                                <td>${item.calismaSuresi}</td>
                                <td>${item.durum}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function raporGelir(basTarih, bitTarih) {
            const { data, error } = await _supabase.from(TABLO.GELIRLER)
                .select('*')
                .gte('tarih', basTarih)
                .lte('tarih', bitTarih)
                .order('tarih', { ascending: false });

            if (error) throw error;
            if (data.length === 0) return '<p style="color: #6c757d;">Bu tarih aralÄ±ÄŸÄ±nda kayÄ±t bulunamadÄ±.</p>';
            
            const toplam = data.reduce((sum, g) => sum + parseFloat(g.tutar), 0);

             return `
                <h5>ğŸ’° Gelir Raporu (${basTarih} - ${bitTarih})</h5>
                <p><strong>Toplam Gelir:</strong> ${toplam.toFixed(2)} â‚º</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Gelir TÃ¼rÃ¼</th>
                            <th>MÃ¼ÅŸteri/Firma</th>
                            <th>Tutar</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr>
                                <td>${item.tarih}</td>
                                <td>${item.tur}</td>
                                <td>${item.musteri}</td>
                                <td style="color: #38ef7d; font-weight: bold;">${parseFloat(item.tutar).toFixed(2)} â‚º</td>
                                <td>${item.aciklama || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function raporGider(basTarih, bitTarih) {
            const { data, error } = await _supabase.from(TABLO.GIDERLER)
                .select('*')
                .gte('tarih', basTarih)
                .lte('tarih', bitTarih)
                .order('tarih', { ascending: false });
                
            if (error) throw error;
            if (data.length === 0) return '<p style="color: #6c757d;">Bu tarih aralÄ±ÄŸÄ±nda kayÄ±t bulunamadÄ±.</p>';
            
            const toplam = data.reduce((sum, g) => sum + parseFloat(g.tutar), 0);

            return `
                <h5>ğŸ’¸ Gider Raporu (${basTarih} - ${bitTarih})</h5>
                <p><strong>Toplam Gider:</strong> ${toplam.toFixed(2)} â‚º</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Gider TÃ¼rÃ¼</th>
                            <th>Tutar</th>
                            <th>AÃ§Ä±klama</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr>
                                <td>${item.tarih}</td>
                                <td>${item.tur}</td>
                                <td style="color: #f5576c; font-weight: bold;">${parseFloat(item.tutar).toFixed(2)} â‚º</td>
                                <td>${item.aciklama || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function raporKasa(basTarih, bitTarih) {
            const { data: gelirData, error: gError } = await _supabase.from(TABLO.GELIRLER).select('tutar').gte('tarih', basTarih).lte('tarih', bitTarih);
            const { data: giderData, error: dError } = await _supabase.from(TABLO.GIDERLER).select('tutar').gte('tarih', basTarih).lte('tarih', bitTarih);

            if (gError || dError) throw (gError || dError);

            const toplamGelir = gelirData.reduce((sum, g) => sum + parseFloat(g.tutar), 0);
            const toplamGider = giderData.reduce((sum, g) => sum + parseFloat(g.tutar), 0);
            const netKar = toplamGelir - toplamGider;

            return `
                <h5>ğŸ¦ Kasa Ã–zet Raporu (${basTarih} - ${bitTarih})</h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; color: #155724;">Toplam Gelir</p>
                        <h3 style="margin: 5px 0; color: #155724;">${toplamGelir.toFixed(2)} â‚º</h3>
                    </div>
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; color: #721c24;">Toplam Gider</p>
                        <h3 style="margin: 5px 0; color: #721c24;">${toplamGider.toFixed(2)} â‚º</h3>
                    </div>
                    <div style="background: ${netKar >= 0 ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; color: ${netKar >= 0 ? '#155724' : '#721c24'};">Net ${netKar >= 0 ? 'Kar' : 'Zarar'}</p>
                        <h3 style="margin: 5px 0; color: ${netKar >= 0 ? '#155724' : '#721c24'};">${(netKar).toFixed(2)} â‚º</h3>
                    </div>
                </div>
            `;
        }
        
        // raporIndir() fonksiyonu ÅŸimdilik gÃ¼ncellenmedi, 
        // Ã§Ã¼nkÃ¼ Excel indirme (CSV) iÃ§in de verilerin async olarak Ã§ekilmesi gerekiyor.
        // Bu, bir sonraki adÄ±m olabilir.
        function raporIndir() {
            alert('Excel indirme fonksiyonu, verilerin Supabase\'den Ã§ekilmesi iÃ§in ayrÄ±ca gÃ¼ncellenmelidir. Bu versiyonda henÃ¼z aktif deÄŸildir.');
        }


        // =======================================================
        // AYARLAR FONKSÄ°YONLARI
        // =======================================================
        async function aracEkle() {
            console.log('AraÃ§ ekle Ã§alÄ±ÅŸtÄ±');
            showSpinner();
            const plaka = document.getElementById('yeniAracPlaka').value.trim().toUpperCase();
            const model = document.getElementById('yeniAracModel').value.trim() || null;

            if (!plaka) {
                alert('LÃ¼tfen araÃ§ plakasÄ±nÄ± giriniz!');
                hideSpinner();
                return;
            }

            const { error } = await _supabase.from(TABLO.ARAC_LISTESI).insert({
                plaka, model
            });
            
            hideSpinner();
            if(error) {
                if (error.code === '23505') { // Benzersizlik (unique) ihlali
                    alert('Hata: Bu plaka zaten kayÄ±tlÄ±!');
                } else {
                    handleSupabaseError(error, 'AraÃ§ Ekle');
                }
            } else {
                alert('âœ… AraÃ§ baÅŸarÄ±yla eklendi!');
                document.getElementById('yeniAracPlaka').value = '';
                document.getElementById('yeniAracModel').value = '';
                await aracListesiGoster();
                await aracSelectDoldur();
                await dashboardGuncelle();
            }
        }

        async function aracListesiGoster() {
            const { data, error } = await _supabase
                .from(TABLO.ARAC_LISTESI)
                .select('*')
                .order('plaka', { ascending: true });
            
            if (error) return handleSupabaseError(error, 'AraÃ§ Listesi GÃ¶ster');

            const tbody = document.getElementById('aracListTable');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6c757d;">HenÃ¼z araÃ§ kaydÄ± yok</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td><strong>${item.plaka}</strong></td>
                    <td>${item.model || '-'}</td>
                    <td><button class="btn btn-danger btn-small" onclick="aracListSil(${item.id})">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
        }

        async function aracListSil(id) {
            if (!confirm('Bu aracÄ± silmek istediÄŸinizden emin misiniz?')) return;
            showSpinner();
            const { error } = await _supabase.from(TABLO.ARAC_LISTESI).delete().eq('id', id);

            hideSpinner();
            if (error) {
                handleSupabaseError(error, 'AraÃ§ Listesinden Sil');
            } else {
                alert('AraÃ§ silindi.');
                await aracListesiGoster();
                await aracSelectDoldur();
                await dashboardGuncelle();
            }
        }
    </script>
</body>
</html>